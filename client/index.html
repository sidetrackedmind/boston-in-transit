<html ng-app>
  <head>
    <script>
      function Controller($scope) {
        var socket = io.connect();
        var lat = '';
        var long = '';
        var vehicles = {};
        var markers = {};
        
        $scope.last_updated = '';
        
        socket.on('update', function(data) {
          $scope.last_updated = data.date;
          data.entities.forEach(function(entity) {
            var properties = {
              lat: entity.vehicle.position.latitude,
              long: entity.vehicle.position.longitude
            };
            vehicles[entity.vehicle.vehicle.id] = properties;
            if (markers[entity.vehicle.vehicle.id] == null) {
              var marker = L.marker([properties.lat, properties.long], {
                  icon: L.mapbox.marker.icon({
                    'marker-color': '#f86767'
                  })
              });
              
              markerLayer.addLayer(marker);
              markers[entity.vehicle.vehicle.id] = marker;
            }
            else
            {
              markers[entity.vehicle.vehicle.id].setLatLng(L.latLng(properties.lat,properties.long));
            }
          });
          $scope.$apply();
        });
      }
    </script>
    <script src='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.js'></script>
    <link href='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.css' rel='stylesheet' />
    <link href='https://fonts.googleapis.com/css?family=Open+Sans+Condensed:300' rel='stylesheet' type='text/css'>
    <style>
      body { margin:0; padding:0; background: black; color: white; font-family: 'Open Sans Condensed', sans-serif; }
      #map { position:absolute; top:60; bottom:0; width:100%; }
    </style>
  </head>
  <body>
    <div style="padding:10px" class="container" ng-controller="Controller">
      <h1 style="display:inline;">Where's my bus, Boston?</h1>
      <div style="float:right!important">Last updated: <span ng-bind="last_updated"></span></div>
    </div>
    <div id='map'></div>
    <script>
      L.mapbox.accessToken = 'pk.eyJ1IjoiZ3JlZW50IiwiYSI6ImNpazBqdWFsOTM5Nnh2M2x6dWZ2dnB3aHkifQ.97-pFPD8lQf02B6edag1rA';
      var map = L.mapbox.map('map', 'mapbox.streets')
          .setView([42.358056, -71.063611], 10);
      var markerLayer = L.mapbox.featureLayer(null).addTo(map);
      var gtfsLayer = L.mapbox.featureLayer()
        .loadURL('gtfs.geojson')
        .addTo(map);
    </script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/jquery.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="/js/angular.min.js"></script>
  </body>
</html>
